\documentclass{minimal}

\usepackage{luacode}
\usepackage{amsfonts}

\directlua{ require("latex-twitter.lua") }

\newcommand{\Tweet}[1]{\texttt{TWEET(#1)}}

\makeatletter
\newcommand{\Test}[1]{
\bgroup%
\@makeother$
\luaexec{
	local x = string.gsub("#1", "##", "+")
	x = string.gsub(x, "\\n", "\\r\\n")
	x = string.gsub(str, "([^%w %-%_%.%~])")
	tex.print(x)
} %
\egroup
}
\makeatother

\newcommand{\prepare}[1]{\luaexec{tex.print(prepare("#1"))}}

\begin{document}
% %\Test{With backslash: \#}

% \Test{Without backslash: # }

% $x$


Test: \prepare{Nett http://www.example.com/index.php?id=42&x=4.}

\end{document}